@model StoryBoardBud.Data.Board

@{
    ViewData["Title"] = Model.Title;
}

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5>@Model.Title</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">@Model.Description</p>
                    
                    <div class="mb-3">
                        <label for="photoUpload" class="h6">Upload Photo</label>
                        <input type="file" id="photoUpload" accept="image/*" class="form-control form-control-sm" aria-label="Upload photo to board">
                        <small class="text-muted" id="photoUploadHelp">Max 10MB</small>
                        <div id="uploadProgress" class="mt-2" style="display:none;" aria-live="polite" aria-atomic="true">
                            <div class="progress">
                                <div id="progressBar" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="textInput" class="h6">Add Text</label>
                        <input type="text" id="textInput" placeholder="Enter text" class="form-control form-control-sm mb-2" aria-label="Text to add to board">
                        <button class="btn btn-sm btn-primary" onclick="addText()" type="button" aria-label="Add text to board">Add Text</button>
                    </div>

                    <div class="mb-3">
                        <h6 id="favoritesHeading">My Favorite Photos</h6>
                        <div id="favoritePhotos" style="max-height: 300px; overflow-y: auto;" role="region" aria-labelledby="favoritesHeading" aria-live="polite">
                            <p class="text-muted small">Loading...</p>
                        </div>
                    </div>

                    <a href="@Url.Action("MyBoards")" class="btn btn-sm btn-secondary">Back to Boards</a>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div id="boardCanvas" class="board-canvas" role="application" aria-label="Storyboard canvas - drag items to arrange" tabindex="0" style="position: relative; background: #f5f5f5; border: 1px solid #ddd; height: 600px; overflow: auto;">
                @foreach (var item in Model.Items)
                {
                    if (item.Photo != null)
                    {
                        <div class="board-item" data-id="@item.Id" data-zindex="@item.ZIndex" role="img" aria-label="Photo item - draggable" tabindex="0" style="position: absolute; left: @(item.PositionX)px; top: @(item.PositionY)px; width: @(item.Width)px; height: @(item.Height)px; z-index: @item.ZIndex; transform: rotate(@(item.Rotation)deg);">
                            <img src="/@item.Photo.FilePath" alt="Board photo by @(item.Photo.UploadedBy?.UserName ?? "Unknown")" style="width: 100%; height: 100%; object-fit: cover; border: 2px solid var(--border-color); cursor: move;">
                            <div class="resize-handle" style="position: absolute; bottom: 0; right: 0; width: 15px; height: 15px; background: var(--purple-primary); cursor: se-resize; border-radius: 2px 0 0 0;"></div>
                            <div class="item-controls" role="toolbar" aria-label="Item controls" style="position: absolute; top: 5px; left: 5px; display: none; background: rgba(31, 22, 64, 0.9); border-radius: 4px; padding: 2px;">
                                <button class="btn btn-sm btn-light" onclick="bringForward('@item.Id')" type="button" aria-label="Bring forward" title="Bring Forward">▲</button>
                                <button class="btn btn-sm btn-light" onclick="sendBackward('@item.Id')" type="button" aria-label="Send backward" title="Send Backward">▼</button>
                            </div>
                            <button class="btn-close btn-sm" onclick="deleteItem('@item.Id')" type="button" aria-label="Delete photo item" style="position: absolute; top: 5px; right: 5px;"></button>
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(item.TextContent))
                    {
                        <div class="board-item" data-id="@item.Id" data-zindex="@item.ZIndex" role="textbox" aria-label="Text item - draggable and editable" tabindex="0" style="position: absolute; left: @(item.PositionX)px; top: @(item.PositionY)px; width: @(item.Width)px; height: @(item.Height)px; z-index: @item.ZIndex;">
                            <div contenteditable="true" class="text-item" role="textbox" aria-multiline="true" aria-label="Editable text content" style="width: 100%; height: 100%; padding: 8px; border: 2px solid var(--border-color); background: white; color: #000; overflow: hidden; word-wrap: break-word; cursor: move;">@item.TextContent</div>
                            <div class="resize-handle" style="position: absolute; bottom: 0; right: 0; width: 15px; height: 15px; background: var(--purple-primary); cursor: se-resize; border-radius: 2px 0 0 0;"></div>
                            <div class="item-controls" role="toolbar" aria-label="Item controls" style="position: absolute; top: 5px; left: 5px; display: none; background: rgba(31, 22, 64, 0.9); border-radius: 4px; padding: 2px;">
                                <button class="btn btn-sm btn-light" onclick="bringForward('@item.Id')" type="button" aria-label="Bring forward" title="Bring Forward">▲</button>
                                <button class="btn btn-sm btn-light" onclick="sendBackward('@item.Id')" type="button" aria-label="Send backward" title="Send Backward">▼</button>
                            </div>
                            <button class="btn-close btn-sm" onclick="deleteItem('@item.Id')" type="button" aria-label="Delete text item" style="position: absolute; top: 5px; right: 5px;"></button>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

<style>
    .board-canvas {
        position: relative;
        user-select: none;
    }

    .board-item {
        cursor: move;
        touch-action: none;
    }

    .board-item:hover {
        outline: 2px solid var(--purple-primary);
    }

    .board-item:hover .item-controls {
        display: block !important;
    }

    .board-item:hover .resize-handle {
        opacity: 1;
    }

    .board-item.selected {
        outline: 3px solid var(--purple-light);
        z-index: 1000;
    }

    .resize-handle {
        opacity: 0;
        transition: opacity 0.2s;
    }

    .text-item {
        font-family: Arial, sans-serif;
        font-size: 14px;
        white-space: pre-wrap;
        color: #000 !important;
    }
</style>

<script>
    // Board identifier from the server model
    const boardId = '@Model.Id';
    
    // Currently selected board item for drag operations
    let selectedItem = null;
    
    // Mouse/touch offset for accurate drag positioning
    let offset = { x: 0, y: 0 };

    /**
     * Handles photo file upload to server and adds it to the current board.
     * Displays progress indicator during upload and reloads page on success.
     */
    // Photo upload
    document.getElementById('photoUpload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);
        formData.append('isPrivate', false);

        try {
            console.log('Uploading photo...');
            document.getElementById('uploadProgress').style.display = 'block';
            const response = await fetch('/api/photos/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Upload failed:', response.status, errorText);
                throw new Error('Upload failed: ' + response.status);
            }
            const data = await response.json();
            console.log('Photo uploaded:', data);

            // Add to board
            console.log('Adding to board:', boardId);
            const addResponse = await fetch('/api/photos/add-to-board', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    boardId: boardId,
                    photoId: data.id,
                    posX: 50,
                    posY: 50
                })
            });

            if (!addResponse.ok) {
                const errorText = await addResponse.text();
                console.error('Add to board failed:', addResponse.status, errorText);
                throw new Error('Failed to add to board: ' + addResponse.status);
            }

            console.log('Reloading page...');
            location.reload();
        } catch (err) {
            console.error('Error:', err);
            alert('Error uploading photo: ' + err.message);
            document.getElementById('uploadProgress').style.display = 'none';
        }
    });

    /**
     * Drag and Drop System
     * Enables moving board items (photos and text) around the canvas
     */
    const boardItems = document.querySelectorAll('.board-item');
    boardItems.forEach(item => {
        item.addEventListener('mousedown', startDrag);
        item.addEventListener('touchstart', startDrag);
    });

    /**
     * Resize System
     * Enables resizing board items via corner handles
     */
    let resizingItem = null;
    let resizeStart = { x: 0, y: 0, width: 0, height: 0 };

    document.querySelectorAll('.resize-handle').forEach(handle => {
        handle.addEventListener('mousedown', startResize);
        handle.addEventListener('touchstart', startResize);
    });

    /**
     * Initiates resize operation when user clicks/touches a resize handle.
     * @@param {Event} e - Mouse or touch event
     */
    function startResize(e) {
        e.stopPropagation();
        resizingItem = this.closest('.board-item');
        
        resizeStart.x = e.clientX || e.touches[0].clientX;
        resizeStart.y = e.clientY || e.touches[0].clientY;
        resizeStart.width = resizingItem.offsetWidth;
        resizeStart.height = resizingItem.offsetHeight;

        document.addEventListener('mousemove', resize);
        document.addEventListener('touchmove', resize);
        document.addEventListener('mouseup', stopResize);
        document.addEventListener('touchend', stopResize);

        e.preventDefault();
    }

    /**
     * Updates item size during resize operation.
     * @@param {Event} e - Mouse or touch move event
     */
    function resize(e) {
        if (!resizingItem) return;

        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;

        const deltaX = clientX - resizeStart.x;
        const deltaY = clientY - resizeStart.y;

        const newWidth = Math.max(50, resizeStart.width + deltaX);
        const newHeight = Math.max(50, resizeStart.height + deltaY);

        resizingItem.style.width = newWidth + 'px';
        resizingItem.style.height = newHeight + 'px';
    }

    /**
     * Completes resize operation and saves the new size to the server.
     */
    async function stopResize() {
        if (!resizingItem) return;

        document.removeEventListener('mousemove', resize);
        document.removeEventListener('touchmove', resize);
        document.removeEventListener('mouseup', stopResize);
        document.removeEventListener('touchend', stopResize);

        const itemId = resizingItem.dataset.id;
        const posX = parseFloat(resizingItem.style.left);
        const posY = parseFloat(resizingItem.style.top);
        const width = resizingItem.offsetWidth;
        const height = resizingItem.offsetHeight;
        const currentZIndex = parseInt(resizingItem.dataset.zindex || 0);

        // Use auto-save function from site.js
        if (typeof autoSaveItemPosition === 'function') {
            autoSaveItemPosition(itemId, posX, posY, width, height, 0, currentZIndex);
        } else {
            await fetch('/api/photos/update-item', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    itemId: itemId,
                    posX: posX,
                    posY: posY,
                    width: width,
                    height: height,
                    rotation: 0,
                    zIndex: currentZIndex
                })
            });
        }

        resizingItem = null;
    }

    /**
     * Initiates drag operation when user clicks/touches a board item.
     * Records the item and calculates offset for smooth dragging.
     * @@param {Event} e - Mouse or touch event
     */
    function startDrag(e) {
        // Don't start drag if clicking on resize handle
        if (e.target.classList.contains('resize-handle')) return;
        
        selectedItem = this.closest('.board-item');
        selectedItem.classList.add('selected');

        const rect = selectedItem.getBoundingClientRect();
        const canvasRect = document.getElementById('boardCanvas').getBoundingClientRect();
        
        offset.x = e.clientX - rect.left;
        offset.y = e.clientY - rect.top;

        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);

        e.preventDefault();
    }

    /**
     * Updates item position during drag operation.
     * Constrains movement to canvas boundaries.
     * @@param {Event} e - Mouse or touch move event
     */
    function drag(e) {
        if (!selectedItem) return;

        const canvasRect = document.getElementById('boardCanvas').getBoundingClientRect();
        const x = e.clientX - canvasRect.left - offset.x;
        const y = e.clientY - canvasRect.top - offset.y;

        selectedItem.style.left = Math.max(0, x) + 'px';
        selectedItem.style.top = Math.max(0, y) + 'px';
    }

    /**
     * Completes drag operation and saves the new position to the server.
     * Removes event listeners and persists item state via API call.
     */
    async function stopDrag() {
        if (!selectedItem) return;

        document.removeEventListener('mousemove', drag);
        document.removeEventListener('touchmove', drag);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchend', stopDrag);

        const itemId = selectedItem.dataset.id;
        const posX = parseFloat(selectedItem.style.left);
        const posY = parseFloat(selectedItem.style.top);
        const currentZIndex = parseInt(selectedItem.dataset.zindex || 0);

        // Use auto-save function from site.js
        if (typeof autoSaveItemPosition === 'function') {
            autoSaveItemPosition(
                itemId,
                posX,
                posY,
                selectedItem.offsetWidth,
                selectedItem.offsetHeight,
                0, // rotation
                currentZIndex
            );
        } else {
            // Fallback to direct save if site.js not loaded
            await fetch('/api/photos/update-item', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    itemId: itemId,
                    posX: posX,
                    posY: posY,
                    width: selectedItem.offsetWidth,
                    height: selectedItem.offsetHeight,
                    rotation: 0,
                    zIndex: currentZIndex
                })
            });
        }

        selectedItem.classList.remove('selected');
        selectedItem = null;
    }

    /**
     * Adds a new text element to the board at a default position.
     * Validates input and sends creation request to server.
     */
    function addText() {
        const text = document.getElementById('textInput').value;
        if (!text.trim()) {
            alert('Please enter text');
            return;
        }

        console.log('Adding text to board:', boardId, text);
        fetch('/api/photos/add-text', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                boardId: boardId,
                text: text,
                posX: 100,
                posY: 100
            })
        })
        .then(response => {
            console.log('Add text response:', response.status);
            if (!response.ok) {
                return response.text().then(text => {
                    console.error('Add text failed:', text);
                    throw new Error('Failed to add text: ' + response.status);
                });
            }
            return response;
        })
        .then(() => {
            console.log('Text added, reloading...');
            location.reload();
        })
        .catch(err => {
            console.error('Error adding text:', err);
            alert('Error adding text: ' + err.message);
        });
    }

    /**
     * Deletes a board item after user confirmation.
     * Removes the item from both UI and database.
     * @@param {string} itemId - GUID of the board item to delete
     */
    function deleteItem(itemId) {
        if (confirm('Delete this item?')) {
            fetch(`/api/photos/item/${itemId}`, { method: 'DELETE' })
                .then(() => location.reload());
        }
    }

    /**
     * Fetches and displays user's favorite photos in the sidebar.
     * Shows clickable thumbnails that can be added to the board.
     */
    async function loadFavoritePhotos() {
        try {
            const response = await fetch('/api/favorites');
            const data = await response.json();
            const container = document.getElementById('favoritePhotos');
            
            if (data.length === 0) {
                container.innerHTML = '<p class="text-muted small">No favorites yet. <a href=\"/Discover\">Add some</a>!</p>';
                return;
            }

            container.innerHTML = data.map(fav => `
                <div class="mb-2" style="cursor: pointer; border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                    <img src="/${fav.photo.filePath}" style="width: 100%; height: 80px; object-fit: cover;" 
                         onclick="addPhotoToBoard('${fav.photo.id}')">
                    <small class="text-muted d-block p-1">by ${fav.photo.uploadedBy}</small>
                </div>
            `).join('');
        } catch (err) {
            console.error('Error loading favorites:', err);
            document.getElementById('favoritePhotos').innerHTML = '<p class="text-muted small">Error loading favorites</p>';
        }
    }

    /**
     * Adds a favorite photo to the current board at default position.
     * @@param {string} photoId - GUID of the photo to add to board
     */
    async function addPhotoToBoard(photoId) {
        await fetch('/api/photos/add-to-board', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                boardId: boardId,
                photoId: photoId,
                posX: 50,
                posY: 50
            })
        });
        location.reload();
    }

    /**
     * Increases z-index to bring item forward in the layer stack.
     * @@param {string} itemId - GUID of the board item to move forward
     */
    function bringForward(itemId) {
        const item = document.querySelector(`[data-id="${itemId}"]`);
        if (!item) return;

        const currentZ = parseInt(item.dataset.zindex || 0);
        const newZ = currentZ + 1;
        
        item.style.zIndex = newZ;
        item.dataset.zindex = newZ;

        updateItemZIndex(itemId, newZ);
    }

    /**
     * Decreases z-index to send item backward in the layer stack.
     * @@param {string} itemId - GUID of the board item to move backward
     */
    function sendBackward(itemId) {
        const item = document.querySelector(`[data-id="${itemId}"]`);
        if (!item) return;

        const currentZ = parseInt(item.dataset.zindex || 0);
        const newZ = Math.max(0, currentZ - 1);
        
        item.style.zIndex = newZ;
        item.dataset.zindex = newZ;

        updateItemZIndex(itemId, newZ);
    }

    /**
     * Persists z-index changes to the server.
     * @@param {string} itemId - GUID of the board item
     * @@param {number} zIndex - New z-index value for layering
     */
    async function updateItemZIndex(itemId, zIndex) {
        const item = document.querySelector(`[data-id="${itemId}"]`);
        await fetch('/api/photos/update-item', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                itemId: itemId,
                posX: parseFloat(item.style.left),
                posY: parseFloat(item.style.top),
                width: item.offsetWidth,
                height: item.offsetHeight,
                rotation: 0,
                zIndex: zIndex
            })
        });
    }

    // Initialize: Load user's favorite photos when page is ready
    loadFavoritePhotos();
</script>
