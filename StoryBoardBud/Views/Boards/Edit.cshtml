@model StoryBoardBud.Data.Board

@{
    ViewData["Title"] = Model.Title;
}

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5>@Model.Title</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">@Model.Description</p>
                    
                    <div class="mb-3">
                        <h6>Upload Photo</h6>
                        <input type="file" id="photoUpload" accept="image/*" class="form-control form-control-sm">
                        <small class="text-muted">Max 10MB</small>
                        <div id="uploadProgress" class="mt-2" style="display:none;">
                            <div class="progress">
                                <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <h6>Add Text</h6>
                        <input type="text" id="textInput" placeholder="Enter text" class="form-control form-control-sm mb-2">
                        <button class="btn btn-sm btn-primary" onclick="addText()">Add Text</button>
                    </div>

                    <div class="mb-3">
                        <h6>My Favorite Photos</h6>
                        <div id="favoritePhotos" style="max-height: 300px; overflow-y: auto;">
                            <p class="text-muted small">Loading...</p>
                        </div>
                    </div>

                    <a href="@Url.Action("MyBoards")" class="btn btn-sm btn-secondary">Back to Boards</a>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div id="boardCanvas" class="board-canvas" style="position: relative; background: #f5f5f5; border: 1px solid #ddd; height: 600px; overflow: auto;">
                @foreach (var item in Model.Items)
                {
                    if (item.Photo != null)
                    {
                        <div class="board-item" data-id="@item.Id" data-zindex="@item.ZIndex" style="position: absolute; left: @(item.PositionX)px; top: @(item.PositionY)px; width: @(item.Width)px; height: @(item.Height)px; z-index: @item.ZIndex; transform: rotate(@(item.Rotation)deg);">
                            <img src="/@item.Photo.FilePath" alt="Photo" style="width: 100%; height: 100%; object-fit: cover; border: 2px solid #ddd; cursor: move;">
                            <div class="item-controls" style="position: absolute; top: 5px; left: 5px; display: none; background: rgba(255,255,255,0.9); border-radius: 4px; padding: 2px;">
                                <button class="btn btn-sm btn-light" onclick="bringForward('@item.Id')" title="Bring Forward">▲</button>
                                <button class="btn btn-sm btn-light" onclick="sendBackward('@item.Id')" title="Send Backward">▼</button>
                            </div>
                            <button class="btn-close btn-sm" onclick="deleteItem('@item.Id')" style="position: absolute; top: 5px; right: 5px;"></button>
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(item.TextContent))
                    {
                        <div class="board-item" data-id="@item.Id" data-zindex="@item.ZIndex" style="position: absolute; left: @(item.PositionX)px; top: @(item.PositionY)px; width: @(item.Width)px; height: @(item.Height)px; z-index: @item.ZIndex;">
                            <div contenteditable="true" class="text-item" style="width: 100%; height: 100%; padding: 8px; border: 2px solid #ddd; background: white; overflow: hidden; word-wrap: break-word; cursor: move;">@item.TextContent</div>
                            <div class="item-controls" style="position: absolute; top: 5px; left: 5px; display: none; background: rgba(255,255,255,0.9); border-radius: 4px; padding: 2px;">
                                <button class="btn btn-sm btn-light" onclick="bringForward('@item.Id')" title="Bring Forward">▲</button>
                                <button class="btn btn-sm btn-light" onclick="sendBackward('@item.Id')" title="Send Backward">▼</button>
                            </div>
                            <button class="btn-close btn-sm" onclick="deleteItem('@item.Id')" style="position: absolute; top: 5px; right: 5px;"></button>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

<style>
    .board-canvas {
        position: relative;
        user-select: none;
    }

    .board-item {
        cursor: move;
        touch-action: none;
    }

    .board-item:hover {
        outline: 2px solid #007bff;
    }

    .board-item:hover .item-controls {
        display: block !important;
    }

    .board-item.selected {
        outline: 3px solid #28a745;
        z-index: 1000;
    }

    .text-item {
        font-family: Arial, sans-serif;
        font-size: 14px;
        white-space: pre-wrap;
    }
</style>

<script>
    const boardId = '@Model.Id';
    let selectedItem = null;
    let offset = { x: 0, y: 0 };

    // Photo upload
    document.getElementById('photoUpload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);
        formData.append('isPrivate', false);

        try {
            console.log('Uploading photo...');
            document.getElementById('uploadProgress').style.display = 'block';
            const response = await fetch('/api/photos/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Upload failed:', response.status, errorText);
                throw new Error('Upload failed: ' + response.status);
            }
            const data = await response.json();
            console.log('Photo uploaded:', data);

            // Add to board
            console.log('Adding to board:', boardId);
            const addResponse = await fetch('/api/photos/add-to-board', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    boardId: boardId,
                    photoId: data.id,
                    posX: 50,
                    posY: 50
                })
            });

            if (!addResponse.ok) {
                const errorText = await addResponse.text();
                console.error('Add to board failed:', addResponse.status, errorText);
                throw new Error('Failed to add to board: ' + addResponse.status);
            }

            console.log('Reloading page...');
            location.reload();
        } catch (err) {
            console.error('Error:', err);
            alert('Error uploading photo: ' + err.message);
            document.getElementById('uploadProgress').style.display = 'none';
        }
    });

    // Drag and drop handling
    const boardItems = document.querySelectorAll('.board-item');
    boardItems.forEach(item => {
        item.addEventListener('mousedown', startDrag);
        item.addEventListener('touchstart', startDrag);
    });

    function startDrag(e) {
        selectedItem = this.closest('.board-item');
        selectedItem.classList.add('selected');

        const rect = selectedItem.getBoundingClientRect();
        const canvasRect = document.getElementById('boardCanvas').getBoundingClientRect();
        
        offset.x = e.clientX - rect.left;
        offset.y = e.clientY - rect.top;

        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);

        e.preventDefault();
    }

    function drag(e) {
        if (!selectedItem) return;

        const canvasRect = document.getElementById('boardCanvas').getBoundingClientRect();
        const x = e.clientX - canvasRect.left - offset.x;
        const y = e.clientY - canvasRect.top - offset.y;

        selectedItem.style.left = Math.max(0, x) + 'px';
        selectedItem.style.top = Math.max(0, y) + 'px';
    }

    async function stopDrag() {
        if (!selectedItem) return;

        document.removeEventListener('mousemove', drag);
        document.removeEventListener('touchmove', drag);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchend', stopDrag);

        const itemId = selectedItem.dataset.id;
        const posX = parseFloat(selectedItem.style.left);
        const posY = parseFloat(selectedItem.style.top);
        const currentZIndex = parseInt(selectedItem.dataset.zindex || 0);

        await fetch('/api/photos/update-item', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                itemId: itemId,
                posX: posX,
                posY: posY,
                width: selectedItem.offsetWidth,
                height: selectedItem.offsetHeight,
                rotation: 0,
                zIndex: currentZIndex
            })
        });

        selectedItem.classList.remove('selected');
        selectedItem = null;
    }

    function addText() {
        const text = document.getElementById('textInput').value;
        if (!text.trim()) {
            alert('Please enter text');
            return;
        }

        console.log('Adding text to board:', boardId, text);
        fetch('/api/photos/add-text', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                boardId: boardId,
                text: text,
                posX: 100,
                posY: 100
            })
        })
        .then(response => {
            console.log('Add text response:', response.status);
            if (!response.ok) {
                return response.text().then(text => {
                    console.error('Add text failed:', text);
                    throw new Error('Failed to add text: ' + response.status);
                });
            }
            return response;
        })
        .then(() => {
            console.log('Text added, reloading...');
            location.reload();
        })
        .catch(err => {
            console.error('Error adding text:', err);
            alert('Error adding text: ' + err.message);
        });
    }

    function deleteItem(itemId) {
        if (confirm('Delete this item?')) {
            fetch(`/api/photos/item/${itemId}`, { method: 'DELETE' })
                .then(() => location.reload());
        }
    }

    // Load favorite photos
    async function loadFavoritePhotos() {
        try {
            const response = await fetch('/api/favorites');
            const data = await response.json();
            const container = document.getElementById('favoritePhotos');
            
            if (data.length === 0) {
                container.innerHTML = '<p class="text-muted small">No favorites yet. <a href=\"/Discover\">Add some</a>!</p>';
                return;
            }

            container.innerHTML = data.map(fav => `
                <div class="mb-2" style="cursor: pointer; border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                    <img src="/${fav.photo.filePath}" style="width: 100%; height: 80px; object-fit: cover;" 
                         onclick="addPhotoToBoard('${fav.photo.id}')">
                    <small class="text-muted d-block p-1">by ${fav.photo.uploadedBy}</small>
                </div>
            `).join('');
        } catch (err) {
            console.error('Error loading favorites:', err);
            document.getElementById('favoritePhotos').innerHTML = '<p class="text-muted small">Error loading favorites</p>';
        }
    }

    async function addPhotoToBoard(photoId) {
        await fetch('/api/photos/add-to-board', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                boardId: boardId,
                photoId: photoId,
                posX: 50,
                posY: 50
            })
        });
        location.reload();
    }

    function bringForward(itemId) {
        const item = document.querySelector(`[data-id="${itemId}"]`);
        if (!item) return;

        const currentZ = parseInt(item.dataset.zindex || 0);
        const newZ = currentZ + 1;
        
        item.style.zIndex = newZ;
        item.dataset.zindex = newZ;

        updateItemZIndex(itemId, newZ);
    }

    function sendBackward(itemId) {
        const item = document.querySelector(`[data-id="${itemId}"]`);
        if (!item) return;

        const currentZ = parseInt(item.dataset.zindex || 0);
        const newZ = Math.max(0, currentZ - 1);
        
        item.style.zIndex = newZ;
        item.dataset.zindex = newZ;

        updateItemZIndex(itemId, newZ);
    }

    async function updateItemZIndex(itemId, zIndex) {
        const item = document.querySelector(`[data-id="${itemId}"]`);
        await fetch('/api/photos/update-item', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                itemId: itemId,
                posX: parseFloat(item.style.left),
                posY: parseFloat(item.style.top),
                width: item.offsetWidth,
                height: item.offsetHeight,
                rotation: 0,
                zIndex: zIndex
            })
        });
    }

    // Load photos on page load
    loadFavoritePhotos();
</script>
